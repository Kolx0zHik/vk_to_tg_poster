# Техническое задание: VK → Telegram АвтоРепостер

## 1. Цель
Сервис периодически опрашивает заданные сообщества ВКонтакте и публикует новые записи в один Telegram-канал. Для каждой группы можно указать, какие типы контента публиковать. Повторы исключаются с помощью кеша.

## 2. Источники данных
- VK API (`wall.get`), версия задаётся в конфиге (по умолчанию 5.199).
- На старте планируется ~5 сообществ, масштабирование линейное (добавление в конфиг).

## 3. Публикация
- Telegram Bot API, публикация в один канал (в будущем — возможность нескольких каналов через расширение конфига).
- Передача токенов через переменные окружения (`VK_API_TOKEN`, `TELEGRAM_BOT_TOKEN`) или в конфиге.

## 4. Поддерживаемые типы контента
- `text`, `photo`, `video`, `audio`, `link`.
- Для каждой группы настраивается набор разрешённых типов. Неразрешённые вложения игнорируются.

## 5. Расписание
- Глобальный cron-выражение, на каждое срабатывание запускается полный цикл обхода сообществ.
- Значение по умолчанию: каждые 10 минут. Переопределяется в конфиге.

## 6. Фильтрация дубликатов
- Кеш `data/cache.json` хранит хеши опубликованных записей по сообществам.
- Хеш считается от текста + разрешённых вложений. Если хеш уже есть, запись не публикуется.

## 7. Конфигурация и управление
- Без БД. Все настройки в YAML (`config/config.yaml`).
- Основные параметры:
  - `general`: cron, лимит постов, пути к логам и кешу, уровень логирования.
  - `vk`: токен сервиса.
  - `telegram`: токен бота и целевой канал.
  - `communities[]`: id, имя, активность, набор контент-типов.
- Переопределения через переменные окружения: `CONFIG_PATH`, `VK_API_TOKEN`, `TELEGRAM_BOT_TOKEN`, `RUN_MODE` (once|scheduled).

## 8. Логирование
- В файл (`logs/poster.log`) + в stdout.
- Ротация по размеру (`RotatingFileHandler`): по умолчанию 10 МБ, 5 файлов, хранение около 30 дней при стандартной частоте срабатываний.

## 9. Развёртывание
- `docker-compose` + `Dockerfile` на основе `python:3.11-slim`.
- Том для логов и кеша (`./logs`, `./data`), конфиг монтируется read-only.
- Команда по умолчанию: `python -m src.main` (режим расписания).

## 10. Минимальный MVP-функционал
1. Загрузка конфига и инициализация логов.
2. Периодический запуск по cron.
3. Получение свежих постов из `wall.get`.
4. Фильтр по типам вложений и активности группы.
5. Защита от повторов через JSON-кеш (идентификатор поста).
6. Публикация текста и вложений в канал (по одному сообщению на вложение) с кнопкой «Открыть пост в VK».
7. При добавлении нового сообщества отправляются последние `posts_limit` записей; закреплённый пост публикуется один раз.

## 11. Ограничения и допущения
- Нет базы данных; устойчивость к перезапускам обеспечивается файлом кеша.
- Медиа отправляются отдельными сообщениями; групповые отправки (media group) пока не реализованы.
- Валидация входящих данных минимальная; токены обязаны быть заданы через окружение или конфиг.

## 12. Дальнейшие улучшения (после MVP)
- Поддержка нескольких каналов и индивидуальных расписаний по группам.
- Отправка медиагрупп и предпросмотра видео/аудио.
- Режим dry-run и метрики.
- Alerting при ошибках (например, в Telegram).
- Простая CLI/веб-админка для правки конфига.

## 13. Веб-управление конфигурацией (MVP)
- Страница настроек на FastAPI/uvicorn (`src/web.py`), доступная на порту 8000 в том же сервисе, что и планировщик.
- API `/api/config` для чтения/сохранения `config.yaml` без отображения секретов (показывается только статус токенов).
- UI: редактирование cron, лимита постов, канала Telegram, списка сообществ и разрешённых типов контента; добавление/удаление сообществ.
- Токены можно передавать через форму или через переменные окружения; сохранённые значения не отображаются для безопасности.
